(*# MixedStateChoice #*)

(* In this protocol A tells C gossip about B, a lot of gossip, without
B knowing, but eventually B walks by and A shushes C and greets B to
dissimulate.
*)

global protocol LetMeTellYouASecret (role A, role B, role C) {
  rec X {
    choice at A {
      GOSSIP from A to C ; continue X ; (*) here B never learns this choice,
                                        (*) and it's ok because the protocol continues,
                                        (*) and maybe we don't want C to know that A and B
                                        (*) exchange M1s without telling C
    } or {
      SHHHH from A to C ; HI from A to B ;
    }
  }
}

(* this is a more sophisticated example *)


(* This following protocol is morally correct (it should be well
formed), however it is technically wrong according to the well formed
rules. However, nuScr accepts it. *)

global protocol LetMeTellYouASecret2 (role A, role B, role C) {
  choice at B {
    WAVE from B to A ; (*) this message should put B in the list Ξ (or 三 if you want) and then be ill formed in the continue.
    rec X {
      choice at A {
        GOSSIP from A to C ; continue X ; (*) some how this passes.
      } or {
        SHHHH from A to C ; HI from A to B ;
      }
    }
  } or {
    SHOUTOUT from B to A ; SHOUOUT from B to C ;
  }
}

(* this protocol is not well formed, and it should not be accepted,
and it is not. However, I think it is rejected by the lazy unfolding
trying to prevent an infinite loop *)

global protocol LetMeTellYouASecret3 (role A, role B, role C) {
  rec X {
  choice at B {
    WAVE from B to A ;
      choice at A {
        GOSSIP from A to C ; continue X ; (* boom here because B appeared after the rec *)
      } or {
        SHHHH from A to C ; HI from A to B ;
      }
  }
}}
